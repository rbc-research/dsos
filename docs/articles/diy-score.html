<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bring Your Own Scores • dsos</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/journal/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Bring Your Own Scores">
<meta property="og:description" content="dsos">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dsos</a>
        <span class="version label label-info" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/diy-score.html">Bring Your Own Scores</a>
    </li>
    <li>
      <a href="../articles/motivation.html">A 10-minute Crash Course</a>
    </li>
    <li>
      <a href="../articles/dependencies.html">Acknowledgements</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rbc-research/dsos/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="diy-score_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Bring Your Own Scores</h1>
                        <h4 class="author">Vathy M. Kamulete</h4>
            <address class="author_afil">
      Royal Bank of Canada<br><a class="author_email" href="mailto:#"></a><a href="mailto:vathy.kamulete@rbc.com" class="email">vathy.kamulete@rbc.com</a>
      </address>
                  
            <h4 class="date">Last Updated: 2021-09-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rbc-research/dsos/blob/master/vignettes/diy-score.Rmd"><code>vignettes/diy-score.Rmd</code></a></small>
      <div class="hidden name"><code>diy-score.Rmd</code></div>

    </div>

    
    
<p>Please see the <a href="https://arxiv.org/abs/2107.02990">arXiv paper</a> for details. We denote the R package as <code>dsos</code>, to avoid confusion with <code>D-SOS</code>, the method.</p>
<div id="diy-bring-your-own-scores" class="section level2">
<h2 class="hasAnchor">
<a href="#diy-bring-your-own-scores" class="anchor"></a>DIY: Bring Your Own Scores</h2>
<p>We show how easy it is to implement <code>D-SOS</code> for a particular notion of outlyingness. Suppose we want to test for no adverse shift based on isolation scores in the context of multivariate two-sample comparison. To do so, we need two main ingredients: a score function and a method to compute the <span class="math inline">\(p-\)</span>value.</p>
<p>First, the scores are obtained using predictions from isolation forest with the <code>isotree</code> package <span class="citation">(Cortes 2020)</span>. Isolation forest detects <em>isolated</em> points, instances that are typically out-of-distribution relative to the high-density regions of the data distribution. Naturally, any performant method for density-based out-of-distribution detection can effectively be used to achieve the same goal. Isolation forest just happens to be a convenient way to do this. The internal function <code>outliers_no_split</code> shows the implementation of one such score function in the <code>dsos</code> package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">dsos</span><span class="fu">:::</span><span class="va">outliers_no_split</span>
<span class="co">## function (x_train, x_test, num_trees = 500) </span>
<span class="co">## {</span>
<span class="co">##     iso_fit &lt;- isotree::isolation.forest(df = x_train, ntrees = num_trees)</span>
<span class="co">##     os_train &lt;- predict(iso_fit, newdata = x_train)</span>
<span class="co">##     os_test &lt;- predict(iso_fit, newdata = x_test)</span>
<span class="co">##     return(list(test = os_test, train = os_train))</span>
<span class="co">## }</span>
<span class="co">## &lt;bytecode: 0x000000000a0f7898&gt;</span>
<span class="co">## &lt;environment: namespace:dsos&gt;</span></code></pre></div>
<p>Second, we estimate the empirical null distribution for the <span class="math inline">\(p-\)</span>value via permutations. For speed, this is implemented as a sequential Monte Carlo test with the <code>simctest</code> package <span class="citation">(Gandy 2009)</span>. Permutations do not require to derive the asymptotic null distribution for the test statistic. The function <code>od_pt</code> in the <code>dsos</code> package combines the scoring with the inference. The prefix <em>od</em> stands for outlier detection and the suffix <em>pt</em>, for permutations. <code>dsos</code> sometimes provides sample splitting and out-of-bag variants as alternatives to compute <span class="math inline">\(p-\)</span>values. Both sample splitting and out-of-bag variants use the asymptotic null distribution for the test statistic. As a result, they can be appreciably faster than inference based on permutations. The code for <code>od_pt</code> is relatively straightforward.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">dsos</span><span class="fu">::</span><span class="va"><a href="../reference/od_pt.html">od_pt</a></span>
<span class="co">## function (x_train, x_test, R = 1000, num_trees = 500, sub_ratio = 1/2) </span>
<span class="co">## {</span>
<span class="co">##     scorer &lt;- function(x_train, x_test) {</span>
<span class="co">##         outliers_no_split(x_train = x_train, x_test = x_test, </span>
<span class="co">##             num_trees = num_trees)</span>
<span class="co">##     }</span>
<span class="co">##     result &lt;- exchangeable_null(x_train, x_test, scorer, R = R, </span>
<span class="co">##         is_oob = FALSE)</span>
<span class="co">##     return(result)</span>
<span class="co">## }</span>
<span class="co">## &lt;bytecode: 0x00000000122656f8&gt;</span>
<span class="co">## &lt;environment: namespace:dsos&gt;</span></code></pre></div>
<p>Take the <a href="https://en.wikipedia.org/wiki/Iris_flower_data_set"><code>iris</code></a> dataset for example. When the training set only consists of Iris setosa (flower species) and the test set, only of Iris versicolor, the data is incompatible with the null of no adverse shift. In other words, we have strong evidence that the test contains a disproportionate number of outliers, if the training set is the reference distribution.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>
<span class="va">x_train</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> <span class="co"># Training sample: Species == 'setosa'</span>
<span class="va">x_test</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fl">51</span><span class="op">:</span><span class="fl">100</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> <span class="co"># Test sample: Species == 'versicolor'</span>
<span class="va">iris_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/od_pt.html">od_pt</a></span><span class="op">(</span><span class="va">x_train</span>, <span class="va">x_test</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">iris_test</span><span class="op">)</span></code></pre></div>
<p><img src="diy-score_files/figure-html/iris-od-1.png" width="700"></p>
<p>You can plug in your own scores in this framework. Those already implemented in the package can be useful but they are by means the only ones. If you favor a different method for out-of-distribution (outlier) detection, want to tune the hyperparameters, or choose a different notion of outlyingness altogether, <code>dsos</code> provides the building blocks to build your own. The workhorse function, powering the approach behind the scenes, is a way to calculate the the test statistic, the WAUC, from the outlier scores (see <code>wauc_from_os</code>).</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-isotree">
<p>Cortes, David. 2020. <em>Isotree: Isolation-Based Outlier Detection</em>. <a href="https://CRAN.R-project.org/package=isotree">https://CRAN.R-project.org/package=isotree</a>.</p>
</div>
<div id="ref-simctest">
<p>Gandy, Axel. 2009. “Sequential Implementation of Monte Carlo Tests with Uniformly Bounded Resampling Risk.” <em>Journal of the American Statistical Association</em> 104 (488): 1504–11.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Vathy M. Kamulete.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
